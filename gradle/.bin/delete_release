#!/usr/bin/env bash

. io_utils
. git_utils

function main(){
  declare -A options
  options["--batch"]="All questions will be answered with the default answer."
  local arguments=($@)
  declare -A args
  parseArgs args options arguments
  if [ $? -ne 0 ]; then
    printHelp $(basename $0) options
  fi

  local defaultAnswer=""
  if [ "${args["batch"]}" == "true" ]; then
    defaultAnswer="y"
  fi
  declare answer
  local confirmationOptions=(y n)

  if git status --porcelain; then
    confirmation "You have local changes. They might be overwritten if you continue. Do you want to abort?" confirmationOptions answer "$defaultAnswer"
    if [ "$answer" == "y" ]; then
      echo "Aborting due to local git changes."
      exit 1
    fi
  fi

  local tagToDelete=$(latestTag)
  confirmation "Do you want to delete tag '$tagToDelete'?" confirmationOptions answer "$defaultAnswer"

  if [ "$answer" == "n" ]; then
    exit 1
  fi

  current_branch=$(git rev-parse --abbrev-ref HEAD)
  (
    git checkout --detach HEAD
  )
  git checkout -f ${current_branch}
}

main $*